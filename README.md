p.s. не совсем понял с какого момента идет отсчет времени, но я сделал его примерно за 5-6 часов. Если идет учет с момента начала заполнения заявки, то заявку начал заполнять перед сном а продолжил уже с утра, не судите строго)
# Lead Distribution CRM

Мини-CRM для автоматического распределения лидов между операторами по источникам с учётом весов и лимитов нагрузки.

## Быстрый старт

# Запуск сервера
bash 

uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
# Приложение будет доступно по адресу: http://localhost:8000

## Модель данных

### Основные сущности

**Lead**
external_id - внешний идентификатор для объединения лидов  
phone - номер телефона 
email - эл.почта
name - имя клиента


**Contact**
status - статус обращения: "new", "in_progress", "completed"
message - текст обращения
lead - связь с лидом
source - связь с источником
operator - связь с оператором

**Operator**
is_active - True/False
max_active_leads - максимальное количество активных обращений

**Source**
name - уникальное название источника
description - описание

**OperatorSourceWeight**
weight - числовой вес для распределения трафика

### Связи
Lead 1:N Contact
Source 1:N Contact
Operator 1:N Contact
Operator M:M Source (через OperatorSourceWeight)

## Алгоритм распределения

### Определение лида

Поиск существующего лида в порядке приоритета:
1. external_id
2. phone
3. email
Если лид не найден - создается новый.

### Выбор оператора

Фильтрация кандидатов:
- Оператор активен (is_active = True)
- Оператор имеет вес для данного источника
- Текущая нагрузка оператора < максимального лимита

Расчет нагрузки:
- Нагрузка = количество обращений со статусом "new" или "in_progress"
- Доступная емкость = max_active_leads - текущая_нагрузка

Взвешенный выбор:
- Эффективный вес = weight * доступная_емкость
- Используется random.choices() с весами для вероятностного выбора

Крайние случаи:
- Если нет подходящих операторов - обращение создается без назначенного оператора (operator_id = null)

## API Endpoints

POST /operators/ - создание оператора

GET /operators/ - список операторов с информацией о нагрузке

POST /sources/ - создание источника

GET /sources/ - список источников

POST /operator-weights/ - настройка веса оператора для источника

GET /operator-weights/ - список всех настроек распределения

POST /contacts/ - создание обращения (основной endpoint)

GET /contacts/ - список всех обращений

PATCH /contacts/{id}/status - обновление статуса обращения

GET /leads/ - список всех лидов

